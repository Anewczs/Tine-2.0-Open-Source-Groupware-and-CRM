Ext.namespace("Egw.Felamimail");Egw.Felamimail=function(){var H=function(n){var s=n.getRegion("center",false);var h=Ext.Element.get(document.body);var B=h.createChild({tag:"div",id:"gridAddressbook",cls:"x-layout-inactive-content"});var y=new Ext.data.JsonStore({url:"index.php",baseParams:{method:"Felamimail.getData"},root:"results",totalProperty:"totalcount",id:"message_id",fields:[{name:"message_id"},{name:"model"},{name:"description"},{name:"config_id"},{name:"setting_id"},{name:"software_id"}],remoteSort:true});y.setDefaultSort("message_id","desc");y.load();var k=new Ext.grid.ColumnModel([{resizable:true,id:"userid",header:"ID",dataIndex:"userid",width:30},{resizable:true,id:"lastname",header:"lastname",dataIndex:"lastname"},{resizable:true,id:"firstname",header:"firstname",dataIndex:"firstname",hidden:true},{resizable:true,header:"street",dataIndex:"street"},{resizable:true,id:"city",header:"zip/city",dataIndex:"city"},{resizable:true,header:"birthday",dataIndex:"birthday"},{resizable:true,id:"addressbook",header:"addressbook",dataIndex:"addressbook"}]);k.defaultSortable=true;var c=new Ext.grid.Grid(outerDivTag,{ds:y,cm:k,autoSizeColumns:false,selModel:new Ext.grid.RowSelectionModel({multiSelect:true}),enableColLock:false,loadMask:true,enableDragDrop:true,ddGroup:"TreeDD",autoExpandColumn:"n_given"});c.render();var C=c.getView().getHeaderPanel(true);var D=new Ext.PagingToolbar(C,y,{pageSize:50,displayInfo:true,displayMsg:"Displaying contacts {0} - {1} of {2}",emptyMsg:"No contacts to display"});D.insertButton(0,{id:"addbtn",cls:"x-btn-icon",icon:"images/oxygen/16x16/actions/edit-add.png",tooltip:"add new contact",onClick:_openDialog});D.insertButton(1,{id:"editbtn",cls:"x-btn-icon",icon:"images/oxygen/16x16/actions/edit.png",tooltip:"edit current contact",disabled:true,onClick:_openDialog});D.insertButton(2,{id:"deletebtn",cls:"x-btn-icon",icon:"images/oxygen/16x16/actions/edit-delete.png",tooltip:"delete selected contacts",disabled:true,onClick:_openDialog});D.insertButton(3,new Ext.Toolbar.Separator());s.add(new Ext.GridPanel(c));c.on("rowclick",function(z,I,g){var R=c.getSelectionModel().getCount();var J=D.items.map;if(R<1){J.editbtn.disable();J.deletebtn.disable();}else{if(R==1){J.editbtn.enable();J.deletebtn.enable();}else{J.editbtn.disable();J.deletebtn.enable();}}});c.on("rowdblclick",function(J,I,g){var R=J.getDataSource().getAt(I);console.log("id: "+R.data.contact_id);try{_openDialog(R.data.contact_id);}catch(z){}});var c=new Ext.grid.Grid(B,{ds:y,cm:k,autoSizeColumns:false,selModel:new Ext.grid.RowSelectionModel({multiSelect:true}),enableColLock:false,loadMask:true,enableDragDrop:true,ddGroup:"TreeDD",autoExpandColumn:"lastname"});s.remove(0);c.render();s.add(new Ext.GridPanel(c));};var d=function(){var B=new Ext.tree.TreeLoader({dataUrl:"index.php"});B.on("beforeload",function(D,h){D.baseParams.method="Felamimail.getSubTree";D.baseParams.accountId=h.attributes.accountId;D.baseParams.folderName=h.attributes.folderName;D.baseParams.location="mainTree";},this);var s=new Ext.tree.TreePanel({title:"Email",id:"felamimail-tree",loader:B,rootVisible:false,border:false});var c=new Ext.tree.TreeNode({text:"root",draggable:false,allowDrop:false,id:"root"});s.setRootNode(c);for(i=0;i<initialTree.Felamimail.length;i++){c.appendChild(new Ext.tree.AsyncTreeNode(initialTree.Felamimail[i]));}s.on("click",function(D,h){var y=Egw.Egwbase.getActiveToolbar();if(y!=false&&y.id=="toolbarFelamimail"){Ext.getCmp("gridFelamimail").getStore().load({params:{start:0,limit:50}});}else{Egw.Felamimail.Email.show();}},this);s.on("beforeexpand",function(h){if(h.getSelectionModel().getSelectedNode()==null){h.expandPath("/root");}h.fireEvent("click",h.getSelectionModel().getSelectedNode());},this);s.on("contextmenu",function(D,h){h.stopEvent();});return s;};return {getPanel:d,};}();Egw.Felamimail.Email=function(){var y=function(n,k){Ext.MessageBox.confirm("Confirm","Do you really want to delete the selected access log entries?",function(g){if(g=="yes"){var I=Array();var J=Ext.getCmp("gridAdminAccessLog").getSelectionModel().getSelections();for(var R=0;R<J.length;++R){I.push(J[R].id);}new Ext.data.Connection().request({url:"index.php",method:"post",scope:this,params:{method:"Admin.deleteAccessLogEntries",logIds:Ext.util.JSON.encode(I)},callback:function(T,t,P){if(t==true){var z=Ext.util.JSON.decode(P.responseText);if(z.success==true){Ext.getCmp("gridAdminAccessLog").getStore().reload();}}}});}});};var s=function(n,k){Ext.getCmp("gridAdminAccessLog").getSelectionModel().selectAll();};var c=new Ext.Action({text:"delete entry",disabled:true,handler:y,iconCls:"action_delete"});var H=new Ext.Action({text:"select all",handler:s});var D=new Ext.menu.Menu({items:[c,"-",H]});var d=function(){var k=new Ext.data.JsonStore({url:"index.php",baseParams:{method:"Admin.getAccessLogEntries"},root:"results",totalProperty:"totalcount",id:"log_id",fields:[{name:"sessionid"},{name:"loginid"},{name:"ip"},{name:"li"},{name:"lo"},{name:"log_id"},{name:"account_id"},{name:"result"}],remoteSort:true});k.setDefaultSort("li","desc");k.on("beforeload",function(n){n.baseParams.filter=Ext.getCmp("quickSearchField").getRawValue();var J=Date.parseDate(Ext.getCmp("adminApplications_dateFrom").getRawValue(),"m/d/y");n.baseParams.from=J.format("Y-m-d\\T00:00:00");var R=Date.parseDate(Ext.getCmp("adminApplications_dateTo").getRawValue(),"m/d/y");n.baseParams.to=R.format("Y-m-d\\T23:59:59");});k.load({params:{start:0,limit:50}});return k;};var B=function(){var g=new Ext.app.SearchField({id:"quickSearchField",width:200,emptyText:"enter searchfilter"});g.on("change",function(){Ext.getCmp("gridAdminAccessLog").getStore().load({params:{start:0,limit:50}});});var n=new Date();var k=new Date(n.getTime()-604800000);var I=new Ext.form.DateField({id:"adminApplications_dateFrom",allowBlank:false,validateOnBlur:false,value:k});var J=new Ext.form.DateField({id:"adminApplications_dateTo",allowBlank:false,validateOnBlur:false,value:n});var R=new Ext.Toolbar({id:"toolbarAdminAccessLog",split:false,height:26,items:[c,"->","Display from: "," ",I,new Ext.Toolbar.Spacer(),"to: "," ",J,new Ext.Toolbar.Spacer(),"-","Search:"," "," ",g]});Egw.Egwbase.setActiveToolbar(R);I.on("valid",function(z){var P=Date.parseDate(Ext.getCmp("adminApplications_dateFrom").getRawValue(),"m/d/y");var T=Date.parseDate(Ext.getCmp("adminApplications_dateTo").getRawValue(),"m/d/y");if(P.getTime()>T.getTime()){Ext.getCmp("adminApplications_dateTo").setRawValue(Ext.getCmp("adminApplications_dateFrom").getRawValue());}Ext.getCmp("gridAdminAccessLog").getStore().load({params:{start:0,limit:50}});});J.on("valid",function(z){var P=Date.parseDate(Ext.getCmp("adminApplications_dateFrom").getRawValue(),"m/d/y");var T=Date.parseDate(Ext.getCmp("adminApplications_dateTo").getRawValue(),"m/d/y");if(P.getTime()>T.getTime()){Ext.getCmp("adminApplications_dateFrom").setRawValue(Ext.getCmp("adminApplications_dateTo").getRawValue());}Ext.getCmp("gridAdminAccessLog").getStore().load({params:{start:0,limit:50}});});};var C=function(n,I,g,k,R,J){switch(n){case "-3":return "invalid password";break;case "-2":return "ambiguous username";break;case "-1":return "user not found";break;case "0":return "failure";break;case "1":return "success";break;}};var h=function(){c.setDisabled(true);var k=d();var g=new Ext.PagingToolbar({pageSize:50,store:k,displayInfo:true,displayMsg:"Displaying access log entries {0} - {1} of {2}",emptyMsg:"No access log entries to display"});var J=new Ext.grid.ColumnModel([{resizable:true,header:"Session ID",id:"sessionid",dataIndex:"sessionid",width:200,hidden:true},{resizable:true,header:"Login Name",id:"loginid",dataIndex:"loginid"},{resizable:true,header:"IP Address",id:"ip",dataIndex:"ip",width:150},{resizable:true,header:"Login Time",id:"li",dataIndex:"li",width:120},{resizable:true,header:"Logout Time",id:"lo",dataIndex:"lo",width:120},{resizable:true,header:"Account ID",id:"account_id",dataIndex:"account_id",width:70,hidden:true},{resizable:true,header:"Result",id:"result",dataIndex:"result",width:110,renderer:C}]);J.defaultSortable=true;var R=new Ext.grid.RowSelectionModel({multiSelect:true});R.on("selectionchange",function(z){var I=z.getCount();if(I<1){c.setDisabled(true);}else{c.setDisabled(false);}});var n=new Ext.grid.GridPanel({id:"gridAdminAccessLog",store:k,cm:J,tbar:g,autoSizeColumns:false,selModel:R,enableColLock:false,loadMask:true,autoExpandColumn:"loginid",border:false});Egw.Egwbase.setActiveContentPanel(n);n.on("rowcontextmenu",function(z,I,T){T.stopEvent();if(!z.getSelectionModel().isSelected(I)){z.getSelectionModel().selectRow(I);c.setDisabled(false);}D.showAt(T.getXY());});};return {show:function(){B();h();}};}();